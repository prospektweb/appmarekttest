# Prospektweb Calc (Bitrix module)

Модуль `prospektweb.calc` реализует цепочку калькуляторов себестоимости и формирования цен в проектах на 1C‑Битрикс. Решение создаёт необходимые инфоблоки, хранит справочники материалов и операций, позволяет запускать отдельные калькуляторы или целые цепочки, а также выводит административный интерфейс для базовых настроек.

## Ключевые возможности

- **Автозагрузка классов** — регистрация всех калькуляторов, сервисов и установочных классов выполняется через `include.php`, поэтому модуль готов к использованию сразу после установки.
- **Цепочки калькуляторов** — каждый калькулятор описывает свои ограничения, поддерживает ли цепочку и может ли финализировать цену, что позволяет компонировать расчёты.
- **Справочники и демо‑данные** — мастер установки создаёт типы инфоблоков, набор справочных инфоблоков и при необходимости заполняет их примерами.
- **Настройка типов цен** — встроенный калькулятор маркетинговых цен умеет рассчитывать наценки по диапазонам и применять «чарующие» цены.
- **Административные настройки** — страница параметров модуля позволяет выбрать тип цены по умолчанию, валюту и включить логирование.

## Структура и основные компоненты

### Калькуляторы (`lib/Calculator`)

Все калькуляторы наследуются от `BaseCalculator`, реализующего общие методы: загрузку сущностей, валидацию, работу с конфигурацией, нормализацию опций и вспомогательное логирование. Интерфейс `CalculatorInterface` задаёт контракт для всех реализаций (коды, названия, опции, участие в цепочке и т.д.).

Доступные реализации:
- **DigitalSheet (`digital_sheet`)** — заготовка калькулятора цифровой листовой печати. Поддерживает участие в цепочке, финализирует цены и может менять стоимость. Описывает конфигурацию полей (операция, оборудование, материал) и дополнительные опции (припуски). В расчёте пока оставлен TODO, но формируется структура результата и ведётся логирование. 【F:lib/Calculator/Calculators/DigitalSheet.php†L1-L110】【F:lib/Calculator/Calculators/DigitalSheet.php†L112-L191】
- **RollLamination (`roll_lamination`)** — шаг постпечатной обработки. Требует предварительного шага `digital_sheet`, не может быть первым в цепочке, но финализирует и изменяет цену. Описывает опции плёнки, работы, двустороннего ламинирования и процента отходов; расчёт тоже отмечен как TODO, но логирование реализовано. 【F:lib/Calculator/Calculators/RollLamination.php†L1-L174】【F:lib/Calculator/Calculators/RollLamination.php†L176-L237】
- **DimensionsWeight (`dimensions_weight`)** — сервисный калькулятор пересчёта габаритов и веса на основе выбранной единицы измерения и состава материалов. Поддерживает участие в цепочке и собирает настройки пересчёта для каждого измерения. 【F:lib/Calculator/Calculators/DimensionsWeight.php†L1-L125】【F:lib/Calculator/Calculators/DimensionsWeight.php†L127-L191】
- **PriceSettings (`price_settings`)** — системный калькулятор, автоматически завершающий цепочку, если есть шаги, способные менять цену. Рассчитывает цены по типам с учётом наценок и опционального маркетингового снижения (например, 1990 вместо 2000). 【F:lib/Calculator/Calculators/PriceSettings.php†L1-L141】【F:lib/Calculator/Calculators/PriceSettings.php†L143-L262】

### Сервисы (`lib/Services`)

Базовый калькулятор использует вспомогательные сервисы:
- `EntityLoader` — загрузка сущностей инфоблоков и каталога (детали см. файл);
- `ValidationService` — валидация данных и сборка ссылок на элементы;
- `ResultWriter` — запись результатов расчётов;
- `DependencyTracker` — отслеживание зависимостей между калькуляторами.

### Конфигурация (`lib/Config`)

`ConfigManager` отвечает за хранение ключевых ID инфоблоков и параметров модуля через `Bitrix\Main\Config\Option`, а `SettingsManager` используется страницей настроек для сохранения базовых значений (тип цены по умолчанию, валюта, включение логирования). 【F:lib/Config/ConfigManager.php†L1-L98】【F:options.php†L1-L123】

### Установка и демо‑данные (`lib/Install` и `install/*`)

Класс `Installer` реализует полный сценарий установки: создание типов инфоблоков, самих инфоблоков и SKU‑связей, добавление свойств в существующие каталоги, сохранение настроек и генерацию демо‑данных. Удаление удаляет созданные инфоблоки и типы и чистит настройки. Файлы в каталоге `install/` предоставляют шаги мастера установки для веб‑интерфейса. 【F:lib/Install/Installer.php†L1-L191】【F:lib/Install/Installer.php†L193-L275】

### Административная страница (`options.php`)

Страница в административной панели Битрикс выводит две вкладки: основные настройки и список созданных инфоблоков. Администратор выбирает тип цены и валюту по умолчанию, включает логирование, а также видит ссылки на каждый инфоблок, созданный модулем, если он существует. 【F:options.php†L1-L123】【F:options.php†L125-L167】

### Точки подключения

- `include.php` регистрирует автозагрузку всех классов модуля; подключайте модуль `prospektweb.calc`, чтобы использовать калькуляторы и сервисы. 【F:include.php†L1-L24】
- Служебные скрипты в `tools/` могут использоваться для интеграции с административными разделами или REST‑точками (например, списки калькуляторов и конфигураций).

## Как установить

1. Убедитесь, что установлены модули `iblock`, `catalog` и `currency` Битрикс.
2. Установите модуль `prospektweb.calc` стандартным способом через административный интерфейс или программно вызовите `Prospektweb\Calc\Install\Installer::install()`, передав ID инфоблоков товаров и торговых предложений и флаг создания демо‑данных. 【F:lib/Install/Installer.php†L1-L141】
3. В настройках модуля (`/bitrix/admin/settings.php?lang=ru&mid=prospektweb.calc`) укажите тип цены и валюту по умолчанию и, при необходимости, включите логирование. 【F:options.php†L1-L123】
4. Используйте созданные инфоблоки для хранения материалов, работ, оборудования и конфигураций калькуляторов; при необходимости проверьте ссылки на них на вкладке «Инфоблоки» страницы настроек. 【F:options.php†L125-L167】

### Где хранятся ссылки на инфоблоки

ID всех инфоблоков, созданных установщиком модуля, а также ID каталога товаров и торговых предложений сохраняются в настройках модуля (`Bitrix\\Main\\Config\\Option`) под ключами `PRODUCT_IBLOCK_ID`, `SKU_IBLOCK_ID` и `IBLOCK_<КОД>`. Эти значения можно просмотреть и обновить на вкладке «Инфоблоки» административной страницы настроек (`options.php`). 【F:lib/Install/Installer.php†L120-L150】【F:options.php†L125-L167】

## Как использовать

- Создайте набор конфигураций калькуляторов в инфоблоках, затем формируйте цепочку расчётов, комбинируя доступные реализации (`digital_sheet`, `roll_lamination`, `dimensions_weight`, `price_settings`).
- Передавайте в каждый калькулятор контекст с ID торгового предложения, признаками шага цепочки и дополнительными данными (например, текущей себестоимостью для `PriceSettings`).
- Изучите спецификацию опций каждого калькулятора, чтобы подать корректные поля (элементы инфоблоков, чекбоксы, числовые параметры). Лог расчётов пишется в `/local/logs` по имени калькулятора. 【F:lib/Calculator/BaseCalculator.php†L95-L183】

## Известные ограничения

- Логика расчётов для `DigitalSheet`, `RollLamination` и `DimensionsWeight` содержит пометки TODO и требует реализации бизнес‑формул. Структура опций и результатов уже подготовлена.
- Маркетинговое округление цен в `PriceSettings` рассчитывается на основе текущей закупочной цены в контексте; убедитесь, что контекст передаёт `totalCost`.

## Дополнительные материалы

- Исходный код в директории `lib/` содержит примеры того, как описывать опции для фронтенда (типы полей, значения по умолчанию, множественность) и как нормализовать входные данные.
- Скрипты установки в `install/` можно адаптировать для автоматизации развёртывания на стендах или при миграциях.
