# Рефакторинг логики проверки CALC_PRESET: До и После

## ❌ ДО рефакторинга (дублирование логики)

```
┌─────────────────────────────────────────────────────────────────┐
│ Пользователь выбирает ТП и нажимает "Калькуляция"              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ calculator.js:openCalculatorDialog                              │
│ ├─ Проверка 1: ensurePresetAvailability()                      │
│ │  ├─ AJAX: checkPresets                                       │
│ │  └─ AJAX: createAndAssignPreset (если нужно)                │
│ └─ Создание BX.CAdminDialog                                    │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ Iframe загружен → отправляет READY                              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ integration.js:handleReady                                      │
│ ├─ Проверка 2: checkPresets() 🔴 ДУБЛИРОВАНИЕ                  │
│ │  ├─ AJAX: checkPresets                                       │
│ │  └─ AJAX: createAndAssignPreset (если нужно)                │
│ └─ fetchInitData()                                             │
└─────────────────────────────────────────────────────────────────┘

🔴 ПРОБЛЕМЫ:
- Проверка пресетов выполняется ДВА РАЗА
- Лишние AJAX-запросы замедляют работу
- Дублирование кода усложняет поддержку
- Пользователь может увидеть два запроса подтверждения
```

## ✅ ПОСЛЕ рефакторинга (оптимизированная логика)

```
┌─────────────────────────────────────────────────────────────────┐
│ Пользователь выбирает ТП и нажимает "Калькуляция"              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ calculator.js:openCalculatorDialog                              │
│ ├─ ✅ Единственная проверка: ensurePresetAvailability()        │
│ │  ├─ AJAX: checkPresets                                       │
│ │  └─ AJAX: createAndAssignPreset (если нужно)                │
│ └─ Создание BX.CAdminDialog (только после успешной проверки)   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ Iframe загружен → отправляет READY                              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ integration.js:handleReady                                      │
│ └─ ✅ Только fetchInitData() (проверка уже выполнена)          │
└─────────────────────────────────────────────────────────────────┘

✅ ПРЕИМУЩЕСТВА:
- Проверка пресетов выполняется ОДИН РАЗ
- Минимум AJAX-запросов → быстрее
- Нет дублирования кода
- Пользователь видит один запрос подтверждения
- Проще поддерживать и тестировать
```

## 📊 Сравнение количества запросов

### ❌ До рефакторинга:
```
1. calculator.js → checkPresets
2. calculator.js → createAndAssignPreset (при необходимости)
3. Создание диалога
4. integration.js → checkPresets (ДУБЛИРОВАНИЕ!)
5. integration.js → createAndAssignPreset (ДУБЛИРОВАНИЕ!)
6. integration.js → fetchInitData

Итого: до 6 этапов, из них 2 дублирующихся
```

### ✅ После рефакторинга:
```
1. calculator.js → checkPresets
2. calculator.js → createAndAssignPreset (при необходимости)
3. Создание диалога
4. integration.js → fetchInitData

Итого: 4 этапа, без дублирования
```

## 🎯 Ключевые изменения

### integration.js
```diff
async handleReady(message, event) {
-   const skipPresetCheck = this.config.presetCheckResult && this.config.presetCheckResult.skipPresetCheck;
-   
-   if (!skipPresetCheck) {
-       const presetCheck = await this.checkPresets();
-       
-       if (presetCheck.needsConfirmation) {
-           const confirmed = confirm('Необходимо создать новый пресет калькуляции');
-           
-           if (!confirmed) {
-               if (typeof this.config.onClose === 'function') {
-                   this.config.onClose();
-               }
-               return;
-           }
-           
-           await this.createAndAssignPreset();
-       }
-   }
+   // Проверка пресетов теперь выполняется ДО создания диалога в calculator.js
    
    const initData = await this.fetchInitData();
    this.sendMessageToIframe('INIT', initData, message.requestId);
}

- async checkPresets() { ... }  // УДАЛЕНО
- async createAndAssignPreset() { ... }  // УДАЛЕНО
```

## 📈 Результат

| Метрика | До | После | Улучшение |
|---------|----|----|-----------|
| Строк кода в integration.js | 2022 | 1901 | -121 строка (-6%) |
| Методов проверки пресетов | 2 | 1 | -50% |
| AJAX запросов | 4-6 | 2-3 | -33% до -50% |
| Запросов подтверждения | 0-2 | 0-1 | Стабильно 1 |
| Скорость загрузки | Медленнее | Быстрее | ⬆️ Оптимизация |

