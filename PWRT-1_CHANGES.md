# PWRT-1 Protocol Changes

Дата: 2025-12-17

## Описание

Глобальные изменения в модуле согласно протоколу pwrt-1 для поддержки расширенных настроек калькуляторов и хранения символьных кодов элементов.

## Изменения

### 1. Обновление свойств инфоблока CALC_SETTINGS

В инфоблоке CALC_SETTINGS теперь создаются/настраиваются следующие свойства с правильной сортировкой:

1. **PATH_TO_SCRIPT** (Сорт. 100)
   - Название: "Путь к скрипту расчёта"
   - Тип: Привязка к файлу (FileMan)
   - По умолчанию указывает на: `/bitrix/modules/prospektweb.calc/lib/Calculator/Calculators/`

2. **USE_OPERATION** (Сорт. 200)
   - Название: "Активировать Операцию"
   - Тип: Список
   - Варианты: "Да" (XML_ID = Y) / "Нет" (XML_ID = N)

3. **DEFAULT_OPERATION** (Сорт. 250)
   - Название: "Операция по умолчанию"
   - Тип: Привязка к элементу
   - Привязка к инфоблоку: CALC_OPERATIONS

4. **SUPPORTED_EQUIPMENT_LIST** (Сорт. 300)
   - Название: "Поддерживаемое оборудование"
   - Тип: Привязка к элементу (множественное)
   - Привязка к инфоблоку: CALC_EQUIPMENT

5. **USE_MATERIAL** (Сорт. 400)
   - Название: "Активировать Материал"
   - Тип: Список
   - Варианты: "Да" (XML_ID = Y) / "Нет" (XML_ID = N)

6. **DEFAULT_MATERIAL** (Сорт. 450)
   - Название: "Материал по умолчанию"
   - Тип: Привязка к элементу
   - Привязка к инфоблоку: CALC_MATERIALS

7. **CAN_BE_FIRST** (Сорт. 500)
   - Название: "Может быть добавлен на первом этапе"
   - Тип: Список
   - Варианты: "Да" (XML_ID = Y) / "Нет" (XML_ID = N)

8. **REQUIRES_BEFORE** (Сорт. 550)
   - Название: "Используется после калькулятора"
   - Тип: Привязка к элементу
   - Привязка к инфоблоку: CALC_SETTINGS (на себя)

9. **DEFAULT_OPTIONS** (Сорт. 600)
   - Название: "Опции по умолчанию"
   - Тип: HTML/текст

### 2. Добавление поддержки CODE (символьного кода элемента)

Во всех местах, где загружаются элементы из Битрикс, теперь помимо ID также загружается и возвращается поле CODE:

#### Обновленные файлы:

- **lib/Calculator/ElementDataService.php**
  - Метод `loadElements()` теперь включает поле CODE в запросе и возвращаемых данных
  - В каждом элементе добавлено поле `'code' => $fields['CODE'] ?? null`

- **lib/Calculator/InitPayloadService.php**
  - Метод `loadOffers()` теперь включает поле CODE
  - В структуре offer добавлено поле `'code' => $element['CODE'] ?? null`

- **lib/Services/EntityLoader.php**
  - Уже поддерживал загрузку CODE через `['*']` - не требует изменений

- **tools/equipment.php**
  - API endpoint теперь возвращает CODE для каждого оборудования
  - Добавлено поле `'code' => $item['FIELDS']['CODE'] ?? null`

- **tools/config.php**
  - API endpoint теперь возвращает CODE для конфигураций
  - Добавлено поле `'code' => $arElement['CODE'] ?? null`

- **tools/elements.php**
  - Уже включал CODE в ответе - не требует изменений

### 3. Улучшения установки модуля

#### lib/Install/IblockCreator.php

- Метод `createCalcSettingsIblock()` полностью переработан с новыми свойствами
- Метод `createProperty()` расширен для поддержки:
  - Разрешения LINK_IBLOCK_CODE в LINK_IBLOCK_ID
  - Установки DEFAULT_VALUE
  - Установки FILE_TYPE для FileMan

#### install/step3.php

- Обновлены свойства для CALC_SETTINGS с правильной сортировкой
- Добавлен блок для обновления привязок свойств после создания всех инфоблоков
- Автоматически связывает свойства DEFAULT_OPERATION, SUPPORTED_EQUIPMENT_LIST, DEFAULT_MATERIAL и REQUIRES_BEFORE с соответствующими инфоблоками

## Обратная совместимость

Все изменения обратно совместимы:

- Поле CODE добавлено к существующим данным, не заменяя ID
- Новые свойства CALC_SETTINGS создаются при установке/обновлении
- Старые методы работы с ID продолжают функционировать

## Миграция

При установке/обновлении модуля:

1. Автоматически создаются новые свойства CALC_SETTINGS
2. Устанавливаются правильные привязки к инфоблокам
3. CODE начинает загружаться и передаваться во всех API

Дополнительных действий от пользователя не требуется.

## Примечания

- CODE может быть `null` для элементов, у которых символьный код не установлен
- ID остается основным идентификатором для всех операций
- CODE используется для удобной идентификации и отладки
