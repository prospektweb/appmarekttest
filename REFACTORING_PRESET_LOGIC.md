# Рефакторинг логики проверки CALC_PRESET

## Описание задачи

Провести рефакторинг серверной логики, отвечающей за работу с торговыми предложениями (ТП) и их привязкой к CALC_PRESET.

## Требования

1. Перед созданием элемента BX.CAdminDialog нужно выполнить проверку свойства CALC_PRESET на сервере у всех выбранных ТП
   - Если свойство CALC_PRESET у всех одинаковое → вернуть успешный ответ для запуска BX.CAdminDialog
   - Если свойство пустое или имеются различия → вернуть сигнал о необходимости создания нового CALC_PRESETS

2. Если клиент отправит запрос на создание элемента CALC_PRESETS → сервер должен создать новый элемент и обновить свойство CALC_PRESET для всех переданных ТП

3. Удалить весь старый код, связанный с API checkPresets, который больше не используется

4. Убедиться, что логика протестирована и выполняется в минимальное время

## Выполненные изменения

### 1. Удален дублирующий код из integration.js

**Файл:** `install/assets/js/integration.js`

#### Удалено из метода `handleReady`:
- Дублирующая проверка пресетов (строки 1629-1654)
- Логика подтверждения создания нового пресета
- Вызов `checkPresets()` и `createAndAssignPreset()`

#### Удалены неиспользуемые методы:
- `checkPresets()` (строки 1830-1871)
- `createAndAssignPreset()` (строки 1877-1918)

**Причина удаления:** Эти методы дублировали функциональность, которая уже корректно реализована в `calculator.js:ensurePresetAvailability`.

### 2. Исправлена синтаксическая ошибка

**Файл:** `tools/calculator_ajax.php`

**Изменение:** Удален лишний закрывающий фигурный брекет на строке 315

### 3. Сохранена корректная логика

Оставлены без изменений следующие компоненты, которые реализуют требуемую функциональность:

#### calculator.js
- **Метод:** `ensurePresetAvailability` (строки 303-367)
- **Назначение:** Проверяет CALC_PRESET на сервере ПЕРЕД созданием BX.CAdminDialog
- **Логика:**
  1. Вызывает `checkPresets` на сервере
  2. Если все ТП имеют одинаковый пресет → возвращает успех
  3. Если нет → запрашивает подтверждение пользователя
  4. При подтверждении вызывает `createAndAssignPreset` на сервере
  5. Только после этого создается BX.CAdminDialog

#### calculator_ajax.php
- **Обработчик:** `handleCheckPresets` (строки 192-277)
  - Проверяет свойство CALC_PRESET у всех переданных ТП
  - Определяет, нужно ли подтверждение для создания нового пресета
  - Возвращает информацию о текущем состоянии пресетов

- **Обработчик:** `handleCreateAndAssignPreset` (строки 282-314)
  - Создает новый элемент CALC_PRESET через BundleHandler
  - Привязывает созданный пресет ко всем переданным ТП

#### BundleHandler.php
- **Метод:** `createPreset` (строки 33-63)
  - Создает новый элемент в инфоблоке CALC_PRESETS
  - Обновляет свойство CALC_PRESET у всех переданных ТП

## Итоговая схема работы

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. Пользователь выбирает ТП и нажимает "Калькуляция"            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. calculator.js:openCalculatorDialog                           │
│    ├─ getSelectedOffers() - получить выбранные ТП              │
│    └─ ensurePresetAvailability(offers) - проверить пресеты     │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. AJAX: checkPresets на сервере                                │
│    └─ calculator_ajax.php:handleCheckPresets                    │
│       └─ Проверяет CALC_PRESET у всех ТП                       │
└─────────────────────────┬───────────────────────────────────────┘
                          │
            ┌─────────────┴─────────────┐
            │                           │
            ▼                           ▼
  ┌───────────────────┐      ┌────────────────────┐
  │ Все пресеты       │      │ Разные пресеты    │
  │ одинаковые        │      │ или пустые        │
  └─────┬─────────────┘      └────────┬───────────┘
        │                             │
        │                             ▼
        │                  ┌─────────────────────┐
        │                  │ Запрос подтверждения│
        │                  │ создания пресета    │
        │                  └────────┬────────────┘
        │                           │
        │                           ▼
        │                  ┌─────────────────────┐
        │                  │ AJAX:               │
        │                  │ createAndAssignPreset│
        │                  │ ├─ Создать пресет   │
        │                  │ └─ Привязать к ТП   │
        │                  └────────┬────────────┘
        │                           │
        └───────────┬───────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. Создание BX.CAdminDialog с iframe                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. integration.js:handleReady                                   │
│    ├─ Пресеты уже проверены/созданы                            │
│    └─ Загрузка данных для инициализации (fetchInitData)        │
└─────────────────────────────────────────────────────────────────┘
```

## Преимущества изменений

1. **Устранено дублирование кода** - проверка пресетов выполняется только один раз, до создания диалога
2. **Улучшена производительность** - убраны лишние AJAX-запросы
3. **Упрощена логика** - четкое разделение ответственности между компонентами
4. **Соответствие требованиям** - проверка CALC_PRESET выполняется на сервере ПЕРЕД созданием BX.CAdminDialog

## Тестирование

### Проверка синтаксиса
- ✅ PHP синтаксис: `php -l tools/calculator_ajax.php`
- ✅ JavaScript синтаксис: `node -c install/assets/js/integration.js`
- ✅ JavaScript синтаксис: `node -c install/assets/js/calculator.js`

### Сценарии для ручного тестирования

1. **Сценарий 1: ТП с одинаковым пресетом**
   - Выбрать несколько ТП с одинаковым CALC_PRESET
   - Нажать "Калькуляция"
   - **Ожидаемый результат:** Диалог открывается без запроса подтверждения

2. **Сценарий 2: ТП с разными пресетами**
   - Выбрать несколько ТП с разными CALC_PRESET
   - Нажать "Калькуляция"
   - **Ожидаемый результат:** Показывается запрос подтверждения создания нового пресета

3. **Сценарий 3: ТП без пресетов**
   - Выбрать несколько ТП без CALC_PRESET
   - Нажать "Калькуляция"
   - **Ожидаемый результат:** Показывается запрос подтверждения создания нового пресета

4. **Сценарий 4: Отмена создания пресета**
   - Выбрать ТП без пресета или с разными пресетами
   - Нажать "Калькуляция"
   - В диалоге подтверждения нажать "Отмена"
   - **Ожидаемый результат:** Диалог не открывается, процесс прерывается

5. **Сценарий 5: Подтверждение создания пресета**
   - Выбрать ТП без пресета или с разными пресетами
   - Нажать "Калькуляция"
   - В диалоге подтверждения нажать "OK"
   - **Ожидаемый результат:** Создается новый пресет, привязывается к ТП, открывается диалог

## Файлы с изменениями

- `install/assets/js/integration.js` - удален дублирующий код
- `tools/calculator_ajax.php` - исправлена синтаксическая ошибка

## Файлы без изменений (корректная логика сохранена)

- `install/assets/js/calculator.js` - основная логика проверки пресетов
- `lib/Calculator/BundleHandler.php` - создание и привязка пресетов
- `tools/calculator_ajax.php` - серверные обработчики (логика)
