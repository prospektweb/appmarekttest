# Реализация кастомных полей калькуляторов

## Обзор

Реализована система дополнительных (кастомных) полей для калькуляторов, которая заменяет JSON-поле `OTHER_OPTIONS` в инфоблоке `CALC_SETTINGS` на удобный справочник с кастомной формой редактирования.

## Что реализовано

### 1. Новый инфоблок CALC_CUSTOM_FIELDS

**Тип инфоблока:** `calculator_catalog`  
**Код:** `CALC_CUSTOM_FIELDS`  
**Название:** "Дополнительные поля калькуляторов"

**Свойства инфоблока:**

| Код свойства | Название | Тип | Обязательное | Описание |
|--------------|----------|-----|--------------|----------|
| FIELD_CODE | Символьный код поля | String (S) | Да | Уникальный код (например: BLEED, PAPER_TYPE) |
| FIELD_TYPE | Тип поля | List (L) | Да | Варианты: number, text, checkbox, select |
| DEFAULT_VALUE | Значение по умолчанию | String (S) | Нет | Значение по умолчанию для поля |
| IS_REQUIRED | Обязательное | List (L) | Нет | Да (Y) / Нет (N) |
| UNIT | Единица измерения | String (S) | Нет | Только для number: мм, шт, % |
| MIN_VALUE | Минимальное значение | Number (N) | Нет | Только для number |
| MAX_VALUE | Максимальное значение | Number (N) | Нет | Только для number |
| STEP_VALUE | Шаг | Number (N) | Нет | Только для number |
| MAX_LENGTH | Максимальная длина | Number (N) | Нет | Только для text |
| OPTIONS | Варианты выбора | HTML (S: HTML) | Нет | Только для select: JSON-массив |
| SORT_ORDER | Сортировка | Number (N) | Нет | Порядок отображения |

**Особенность:** Инфоблок настроен с параметром `EDIT_FILE_AFTER = '/bitrix/admin/prospektweb_calc_custom_field.php'`, что автоматически открывает кастомную форму редактирования при клике на элемент в админке.

### 2. Изменения в CALC_SETTINGS

**Удалено:**
- Свойство `OTHER_OPTIONS` (тип HTML)

**Добавлено:**
- Свойство `CUSTOM_FIELDS` (тип E - привязка к элементам)
  - Множественное (MULTIPLE = Y)
  - Количество полей по умолчанию: 3
  - Привязка к инфоблоку: CALC_CUSTOM_FIELDS

### 3. Сервис CustomFieldsService

**Путь:** `lib/Services/CustomFieldsService.php`

**Методы:**

1. **getFieldsConfig(array $fieldIds): array**
   - Получает массив ID элементов CALC_CUSTOM_FIELDS
   - Возвращает конфигурацию полей в формате для фронтенда
   - Автоматически применяет приведение типов для значений по умолчанию
   - Фильтрует параметры в зависимости от типа поля

2. **castDefaultValue(string $value, string $type)**
   - Приводит значение по умолчанию к правильному типу
   - number → float
   - checkbox → boolean
   - text/select → string

**Формат вывода для фронтенда:**

```json
{
  "code": "PAPER_TYPE",
  "name": "Тип бумаги",
  "type": "select",
  "options": [
    {"value": "glossy", "label": "Глянцевая"},
    {"value": "matte", "label": "Матовая"}
  ],
  "default": "glossy",
  "required": true
}
```

### 4. Компонент calc.custom_field.edit

**Путь:** `install/components/prospektweb/calc.custom_field.edit/`

**Структура:**
```
calc.custom_field.edit/
├── class.php              # Логика компонента
├── .description.php       # Метаданные компонента
├── .parameters.php        # Параметры компонента
└── templates/
    └── .default/
        ├── template.php   # HTML-форма
        └── style.css      # Стили формы
```

**Функциональность:**

1. **Динамическое переключение UI**
   - При выборе типа поля автоматически показываются только релевантные параметры
   - `number`: UNIT, MIN_VALUE, MAX_VALUE, STEP_VALUE
   - `text`: MAX_LENGTH
   - `checkbox`: только DEFAULT_VALUE
   - `select`: OPTIONS (JSON-редактор)

2. **Валидация:**
   - Символьный код: только заглавные латинские буквы, цифры и подчёркивание (`[A-Z0-9_]+`)
   - Обязательные поля: NAME, FIELD_CODE, FIELD_TYPE
   - Проверка корректности JSON для OPTIONS

3. **Сохранение:**
   - Создание новых элементов
   - Редактирование существующих
   - Автоматический редирект к списку после сохранения

### 5. Административная страница

**Путь:** `admin/prospektweb_calc_custom_field.php`

**Функции:**
- Проверка прав доступа
- Проверка корректности инфоблока (только CALC_CUSTOM_FIELDS)
- Подключение компонента с передачей параметров
- Интеграция с системой администрирования Битрикс

### 6. Интеграция с ElementDataService

**Путь:** `lib/Calculator/ElementDataService.php`

**Изменения:**
- Добавлена автоматическая загрузка конфигурации кастомных полей
- При загрузке элементов проверяется наличие свойства `CUSTOM_FIELDS`
- Если свойство заполнено, вызывается `CustomFieldsService::getFieldsConfig()`
- Результат добавляется в поле `customFields` элемента данных

**Пример вывода:**
```php
$elementData = [
    'id' => 123,
    'name' => 'Настройка калькулятора',
    'properties' => [...],
    'customFields' => [
        [
            'code' => 'BLEED',
            'name' => 'Вылет за обрез',
            'type' => 'number',
            'unit' => 'мм',
            'min' => 0,
            'max' => 10,
            'default' => 3,
            'required' => false,
        ],
        // ... другие поля
    ],
];
```

### 7. Установка модуля

**Изменения в `install/index.php`:**

1. **Копирование файлов при установке:**
   - `admin/prospektweb_calc_custom_field.php` → `/bitrix/admin/`
   - `install/components/prospektweb/calc.custom_field.edit/` → `/local/components/prospektweb/`

2. **Создание инфоблока:**
   - Обновлена функция `createIblockWithLog()` для поддержки параметра `options`
   - Добавлен параметр `EDIT_FILE_AFTER` для CALC_CUSTOM_FIELDS

**Изменения в `install/step3.php`:**

1. Добавлено определение свойств для CALC_CUSTOM_FIELDS
2. Добавлено создание инфоблока с параметром EDIT_FILE_AFTER
3. Обновлена логика связывания свойства CUSTOM_FIELDS с инфоблоком
4. Изменён счётчик инфоблоков: с 10 на 11

### 8. Автозагрузчик

**Путь:** `include.php`

Добавлена регистрация класса:
```php
'Prospektweb\\Calc\\Services\\CustomFieldsService' => 'lib/Services/CustomFieldsService.php'
```

### 9. Языковые файлы

**Путь:** `lang/ru/admin/prospektweb_calc_custom_field.php`

Добавлены базовые языковые константы для административной страницы.

## Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                    Битрикс Админка                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Список элементов CALC_CUSTOM_FIELDS                 │   │
│  │  (стандартный список инфоблока)                      │   │
│  └──────────────────────────┬───────────────────────────┘   │
│                             │ клик на элемент                │
│                             ↓                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  prospektweb_calc_custom_field.php                   │   │
│  │  (автоматически открывается через EDIT_FILE_AFTER)  │   │
│  └──────────────────────────┬───────────────────────────┘   │
│                             │ включает компонент             │
│                             ↓                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  calc.custom_field.edit                              │   │
│  │  • Валидация полей                                   │   │
│  │  • Динамическое отображение UI                       │   │
│  │  • Сохранение элемента                               │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       Фронтенд                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  InitPayloadService / ElementDataService             │   │
│  │  • Загрузка настроек калькулятора (CALC_SETTINGS)   │   │
│  │  • Обнаружение свойства CUSTOM_FIELDS                │   │
│  └──────────────────────────┬───────────────────────────┘   │
│                             │ вызов                          │
│                             ↓                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  CustomFieldsService                                 │   │
│  │  • Загрузка элементов по ID                          │   │
│  │  • Преобразование в JSON для фронтенда               │   │
│  │  • Фильтрация параметров по типу                     │   │
│  └──────────────────────────┬───────────────────────────┘   │
│                             │ возврат                        │
│                             ↓                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  React-калькулятор                                   │   │
│  │  • Отрисовка кастомных полей                         │   │
│  │  • Валидация значений                                │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Преимущества нового подхода

1. **Удобство редактирования:**
   - Визуальная форма вместо JSON-поля
   - Автоматическая валидация
   - Динамическое изменение UI в зависимости от типа поля

2. **Типобезопасность:**
   - Автоматическое приведение типов (число, строка, boolean)
   - Валидация значений на уровне формы

3. **Переиспользование:**
   - Одни и те же поля можно использовать в разных калькуляторах
   - Справочник позволяет управлять полями централизованно

4. **Расширяемость:**
   - Легко добавить новые типы полей
   - Можно расширить UI для более сложных сценариев

5. **Интеграция с Битрикс:**
   - Использует стандартные механизмы (EDIT_FILE_AFTER)
   - Совместимость с системой прав доступа
   - Работает в рамках административной панели

## Миграция данных

Для миграции существующих данных из `OTHER_OPTIONS` в `CUSTOM_FIELDS`:

1. Создать элементы в CALC_CUSTOM_FIELDS для каждого поля из OTHER_OPTIONS
2. Обновить элементы CALC_SETTINGS, заменив JSON в OTHER_OPTIONS на связи с CALC_CUSTOM_FIELDS
3. (Опционально) Удалить свойство OTHER_OPTIONS после полной миграции

## Тестирование

Рекомендуется протестировать:

1. **Создание инфоблока:**
   - Переустановить модуль или запустить step3.php
   - Проверить наличие инфоблока CALC_CUSTOM_FIELDS
   - Проверить наличие всех свойств

2. **Редактирование элементов:**
   - Создать новое поле через админку
   - Проверить динамическое отображение полей для разных типов
   - Проверить валидацию символьного кода
   - Сохранить и проверить данные

3. **Связь с CALC_SETTINGS:**
   - Добавить созданные поля в настройки калькулятора
   - Проверить отображение в списке

4. **Интеграция с фронтендом:**
   - Загрузить настройки калькулятора через API
   - Проверить наличие поля `customFields` в ответе
   - Проверить корректность данных (типы, значения)

## Файлы, затронутые изменениями

### Новые файлы:
- `lib/Services/CustomFieldsService.php`
- `admin/prospektweb_calc_custom_field.php`
- `install/components/prospektweb/calc.custom_field.edit/class.php`
- `install/components/prospektweb/calc.custom_field.edit/.description.php`
- `install/components/prospektweb/calc.custom_field.edit/.parameters.php`
- `install/components/prospektweb/calc.custom_field.edit/templates/.default/template.php`
- `install/components/prospektweb/calc.custom_field.edit/templates/.default/style.css`
- `lang/ru/admin/prospektweb_calc_custom_field.php`

### Изменённые файлы:
- `include.php` - добавлена регистрация CustomFieldsService
- `install/index.php` - добавлено копирование файлов при установке
- `install/step3.php` - добавлен инфоблок CALC_CUSTOM_FIELDS, изменено свойство в CALC_SETTINGS
- `lib/Calculator/ElementDataService.php` - добавлена интеграция с CustomFieldsService

## Заключение

Реализация полностью соответствует требованиям задачи:
- ✅ Создан новый инфоблок-справочник CALC_CUSTOM_FIELDS
- ✅ Реализована кастомная форма редактирования с динамическим UI
- ✅ Заменено свойство OTHER_OPTIONS на CUSTOM_FIELDS в CALC_SETTINGS
- ✅ Реализован сервис для преобразования данных в формат фронтенда
- ✅ Интегрирован с ElementDataService для автоматической загрузки
- ✅ Все файлы проверены на синтаксические ошибки
- ✅ Компоненты и админские файлы копируются при установке модуля
